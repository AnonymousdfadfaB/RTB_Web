<%- include('../layouts/main', { title: auction.title }) %>

<div class="auction-detail bg-white rounded-lg shadow overflow-hidden">
    <div class="md:flex">
        <!-- Gallery -->
        <div class="md:w-1/2 p-4">
            <div class="main-image mb-4">
                <img id="mainImage" src="<%= auction.images[0] || '/images/default.jpg' %>" alt="<%= auction.title %>" class="w-full rounded-lg">
            </div>
            <div class="thumbnail-grid grid grid-cols-4 gap-2">
                <% auction.images.forEach((image, index) => { %>
                <img src="<%= image %>" alt="Thumbnail <%= index+1 %>"
                     class="thumbnail cursor-pointer <%= index === 0 ? 'border-2 border-indigo-500' : '' %>"
                     onclick="document.getElementById('mainImage').src = this.src;
                     document.querySelectorAll('.thumbnail').forEach(t=> t.classList.remove('border-2', 'border-indigo-500'));
                this.classList.add('border-2', 'border-indigo-500')">
                <% }); %>
            </div>
        </div>

        <!-- Auction Info -->
        <div class="md:w-1/2 p-6">
            <h1 class="text-2xl font-bold mb-2"><%= auction.title %></h1>
            <div class="flex items-center mb-4">
                <span class="bg-gray-200 px-2 py-1 rounded text-sm mr-2"><%= auction.category %></span>
                <span class="text-gray-500">Đăng bởi <%= auction.createdBy.username %></span>
            </div>

            <div class="mb-6">
                <p class="text-gray-700"><%= auction.description %></p>
            </div>

            <!-- Bid Section -->
            <div class="bid-section bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p class="text-gray-500">Giá hiện tại</p>
                        <p id="currentPrice" class="text-3xl font-bold text-indigo-600"><%= auction.currentPrice.toLocaleString() %> VND</p>
                    </div>
                    <div class="text-right">
                        <p class="text-gray-500">Thời gian còn lại</p>
                        <p id="countdown" class="text-xl font-semibold"><%= auction.timeLeft %></p>
                    </div>
                </div>

                <% if (auction.status === 'active') { %>
                <% if (user && user._id.toString() !== auction.createdBy._id.toString()) { %>
                <form id="bidForm" class="space-y-4">
                    <div>
                        <label for="bidAmount" class="block text-gray-700 mb-1">Giá đấu của bạn (VND)</label>
                        <input type="number" id="bidAmount" name="bidAmount"
                               min="<%= auction.currentPrice + 1 %>"
                               value="<%= auction.currentPrice + 1000 %>"
                               class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-gavel mr-2"></i>Đặt giá ngay
                    </button>
                </form>
                <% } else if (!user) { %>
                <div class="text-center py-4">
                    <p class="mb-2">Bạn cần đăng nhập để đặt giá</p>
                    <a href="/auth/login" class="text-indigo-600 hover:underline">Đăng nhập ngay</a>
                </div>
                <% } %>
                <% } else { %>
                <div class="text-center py-4 bg-red-50 rounded-lg">
                    <p class="text-red-600 font-semibold">Phiên đấu giá đã kết thúc</p>
                    <% if (auction.bids.length > 0) { %>
                    <p class="mt-2">Người thắng: <%= auction.bids[0].bidder.username %></p>
                    <p class="text-lg font-bold"><%= auction.currentPrice.toLocaleString() %> VND</p>
                    <% } %>
                </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Bid History -->
    <div class="p-6 border-t">
        <h3 class="text-xl font-semibold mb-4">Lịch sử đấu giá</h3>
        <% if (auction.bids.length > 0) { %>
        <ul id="bidList" class="space-y-3">
            <% auction.bids.forEach(bid => { %>
            <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <div>
                    <span class="font-semibold"><%= bid.bidder.username %></span>
                    <span class="text-gray-500 text-sm ml-2"><%= bid.bidTime.toLocaleString() %></span>
                </div>
                <span class="font-bold text-indigo-600"><%= bid.amount.toLocaleString() %> VND</span>
            </li>
            <% }); %>
        </ul>
        <% } else { %>
        <p class="text-gray-500 text-center py-4">Chưa có lượt đấu giá nào</p>
        <% } %>
    </div>
</div>

<script>
    // Real-time bidding with Socket.io
    const socket = io();
    const auctionId = '<%= auction._id %>';

    socket.emit('joinAuction', auctionId);

    document.getElementById('bidForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const bidAmount = parseInt(document.getElementById('bidAmount').value);
        socket.emit('placeBid', {
            auctionId,
            amount: bidAmount,
            userId: '<%= user?._id %>'
        });
    });

    socket.on('newBid', function (data) {
        document.getElementById('currentPrice').textContent = data.amount.toLocaleString();
        document.getElementById('bidAmount').min = data.amount + 1;
        document.getElementById('bidAmount').value = data.amount + 1000;

        const bidList = document.getElementById('bidList');
        if (bidList) {
            const newBid = document.createElement('li');
            newBid.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
            newBid.innerHTML = `
                <div>
                    <span class="font-semibold">${data.bidder.username}</span>
                    <span class="text-gray-500 text-sm ml-2">${new Date().toLocaleString()}</span>
                </div>
                <span class="font-bold text-indigo-600">${data.amount.toLocaleString()} VND</span>
            `;
            bidList.prepend(newBid);
        }
    });

    // Countdown timer
    const endTime = new Date('<%= auction.endTime %>').getTime();
    const updateCountdown = setInterval(function () {
        const now = new Date().getTime();
        const distance = endTime - now;

        if (distance < 0) {
            clearInterval(updateCountdown);
            document.getElementById('countdown').textContent = "Đã kết thúc";
            return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        document.getElementById('countdown').textContent =
            `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }, 1000);
</script>